name: Dev Branch CI/CD

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

env:
  NODE_VERSION: '20.x'

jobs:
  quality-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ¨ Code formatting check
      run: |
        echo "ğŸ¨ Checking code formatting with Prettier..."
        npm run format:check

    - name: ğŸ” ESLint check
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint

    - name: ğŸ“ TypeScript type check
      run: |
        echo "ğŸ“ Running TypeScript type checking..."
        npm run type-check

    - name: ğŸ—ï¸ Build application
      run: |
        echo "ğŸ—ï¸ Building application..."
        npm run build
        echo "âœ… Build completed successfully!"

    - name: ğŸ“Š Build analysis
      run: |
        echo "ğŸ“Š Analyzing build output..."
        ls -la .next/
        echo "Build size:"
        du -sh .next/

  # ë³´ì•ˆ ë° ì˜ì¡´ì„± ì²´í¬
  security-audit:
    runs-on: ubuntu-latest
    needs: quality-and-build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ”’ Security audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level moderate
      continue-on-error: true

    - name: ğŸ“‹ Dependency check
      run: |
        echo "ğŸ“‹ Checking for outdated packages..."
        npm outdated
      continue-on-error: true

  # í…ŒìŠ¤íŠ¸ (í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°)
  test:
    runs-on: ubuntu-latest
    needs: quality-and-build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ§ª Run tests
      run: |
        if npm run | grep -q "test"; then
          echo "ğŸ§ª Running tests..."
          npm run test
        else
          echo "â„¹ï¸ No test script found, skipping tests"
        fi

  # ìµœì¢… ì„±ê³µ ì•Œë¦¼
  success-notification:
    runs-on: ubuntu-latest
    needs: [quality-and-build, security-audit, test]
    if: success()
    
    steps:
    - name: ğŸ‰ Success notification
      run: |
        echo "ğŸ‰ All CI checks passed successfully!"
        echo ""
        echo "âœ… Code Quality Checks:"
        echo "   - Prettier formatting: âœ…"
        echo "   - ESLint: âœ…"
        echo "   - TypeScript: âœ…"
        echo ""
        echo "âœ… Build & Deploy:"
        echo "   - Production build: âœ…"
        echo "   - Build analysis: âœ…"
        echo ""
        echo "âœ… Security & Dependencies:"
        echo "   - Security audit: âœ…"
        echo "   - Dependency check: âœ…"
        echo ""
        echo "ğŸš€ Code is ready for dev branch!"

  # ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì •ë³´ ì œê³µ
  failure-notification:
    runs-on: ubuntu-latest
    needs: [quality-and-build, security-audit, test]
    if: failure()
    
    steps:
    - name: âŒ Failure notification
      run: |
        echo "âŒ CI Pipeline Failed"
        echo ""
        echo "Please check the following:"
        echo "ğŸ” Code formatting (Prettier)"
        echo "ğŸ” Linting errors (ESLint)" 
        echo "ğŸ” TypeScript type errors"
        echo "ğŸ” Build errors"
        echo ""
        echo "Fix the issues and push again."
        exit 1